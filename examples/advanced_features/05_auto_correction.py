"""
å¹»ç¯ç‰‡ 7: æ ¸å¿ƒ Feature IV â€”â€” è‡ªåŠ¨é”™è¯¯çº æ­£æœºåˆ¶ (Auto-Correction)

å±•ç¤º Pydantic AI çš„è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯çº æ­£
"""

import asyncio
from typing import Optional
from enum import Enum
from pydantic import BaseModel, Field, field_validator, ValidationError
from pydantic_ai import Agent


# ============================================================
# å®šä¹‰ä¸¥æ ¼çº¦æŸçš„è¾“å‡ºæ¨¡å‹
# ============================================================

class Priority(str, Enum):
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


class TaskOutput(BaseModel):
    """
    ä»»åŠ¡è¾“å‡ºæ¨¡å‹
    
    åŒ…å«å¤šç§çº¦æŸ:
    - æšä¸¾å€¼
    - èŒƒå›´é™åˆ¶
    - æ ¼å¼æ ¡éªŒ
    - è‡ªå®šä¹‰éªŒè¯å™¨
    """
    task_name: str = Field(
        min_length=3,
        max_length=50,
        description="ä»»åŠ¡åç§°ï¼Œ3-50å­—ç¬¦"
    )
    
    priority: Priority = Field(
        description="ä¼˜å…ˆçº§: high/medium/low"
    )
    
    estimated_hours: float = Field(
        ge=0.5,
        le=100.0,
        description="é¢„ä¼°å·¥æ—¶ï¼Œ0.5-100å°æ—¶"
    )
    
    assignee_email: str = Field(
        description="è´Ÿè´£äººé‚®ç®±"
    )
    
    tags: list[str] = Field(
        min_length=1,
        max_length=5,
        description="æ ‡ç­¾ï¼Œ1-5ä¸ª"
    )
    
    @field_validator('assignee_email')
    @classmethod
    def validate_email(cls, v):
        if '@' not in v or '.' not in v:
            raise ValueError(f"æ— æ•ˆçš„é‚®ç®±åœ°å€: {v}")
        return v


# ============================================================
# åˆ›å»º Agent (è‡ªåŠ¨æ ¡éªŒ)
# ============================================================

task_agent = Agent(
    "openai:gpt-4o-mini",
    output_type=TaskOutput,  # ğŸ”‘ å…³é”®: æŒ‡å®šè¾“å‡ºç±»å‹
    retries=3,  # ğŸ”‘ å…³é”®: è‡ªåŠ¨é‡è¯•æ¬¡æ•°
    system_prompt="""ä½ æ˜¯ä»»åŠ¡è§„åˆ’åŠ©æ‰‹ã€‚
    
    æ ¹æ®ç”¨æˆ·æè¿°åˆ›å»ºä»»åŠ¡ï¼Œæ³¨æ„:
    - priority å¿…é¡»æ˜¯: high/medium/low (å°å†™)
    - estimated_hours å¿…é¡»æ˜¯æ•°å­—ï¼ŒèŒƒå›´ 0.5-100
    - assignee_email å¿…é¡»æ˜¯æœ‰æ•ˆé‚®ç®±
    - tags å¿…é¡»æ˜¯æ•°ç»„ï¼Œ1-5ä¸ªå…ƒç´ 
    """,
)


# ============================================================
# æ¼”ç¤º: ä¼ ç»Ÿæ–¹å¼çš„æ‰‹åŠ¨é‡è¯•
# ============================================================

def demo_manual_retry():
    """ä¼ ç»Ÿæ–¹å¼: æ‰‹å†™é‡è¯•é€»è¾‘"""
    
    print("=" * 60)
    print("ä¼ ç»Ÿæ–¹å¼: æ‰‹åŠ¨é‡è¯• (ç—›è‹¦)")
    print("=" * 60)
    
    print("""
    async def parse_with_manual_retry(llm_response: str, max_retries: int = 3):
        for attempt in range(max_retries):
            try:
                # 1. è§£æ JSON
                data = json.loads(llm_response)
                
                # 2. æ ¡éªŒæ•°æ®
                result = TaskOutput(**data)
                
                return result
                
            except json.JSONDecodeError as e:
                # JSON æ ¼å¼é”™è¯¯
                if attempt < max_retries - 1:
                    # æ‰‹åŠ¨æ„é€ é‡è¯•æç¤º
                    retry_prompt = f\"\"\"
                    ä¹‹å‰çš„è¾“å‡ºä¸æ˜¯æœ‰æ•ˆçš„ JSON:
                    é”™è¯¯: {e}
                    
                    è¯·é‡æ–°è¿”å›æ­£ç¡®çš„ JSONã€‚
                    \"\"\"
                    # è°ƒç”¨ LLM é‡è¯•...
                    llm_response = await call_llm(retry_prompt)
                else:
                    raise
                    
            except ValidationError as e:
                # Pydantic æ ¡éªŒé”™è¯¯
                if attempt < max_retries - 1:
                    # æ‰‹åŠ¨æ„é€ é‡è¯•æç¤º
                    error_messages = []
                    for error in e.errors():
                        field = error['loc'][0]
                        msg = error['msg']
                        error_messages.append(f"- {field}: {msg}")
                    
                    retry_prompt = f\"\"\"
                    ä¹‹å‰çš„æ•°æ®ä¸ç¬¦åˆè¦æ±‚:
                    {chr(10).join(error_messages)}
                    
                    è¯·ä¿®æ­£å¹¶é‡æ–°è¿”å›ã€‚
                    \"\"\"
                    # è°ƒç”¨ LLM é‡è¯•...
                    llm_response = await call_llm(retry_prompt)
                else:
                    raise
        
        return None
    
    âŒ é—®é¢˜:
    - ä»£ç å†—é•¿
    - éœ€è¦å¤„ç†å¤šç§é”™è¯¯ç±»å‹
    - éœ€è¦ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡
    - æ¯ä¸ªæ¥å£éƒ½è¦å†™ä¸€é
    """)


# ============================================================
# æ¼”ç¤º: Pydantic AI è‡ªåŠ¨çº æ­£
# ============================================================

async def demo_auto_correction():
    """Pydantic AI è‡ªåŠ¨çº æ­£"""
    
    print("\n" + "=" * 60)
    print("Pydantic AI: è‡ªåŠ¨é”™è¯¯çº æ­£")
    print("=" * 60)
    
    print("""
    agent = Agent(
        "openai:gpt-4o-mini",
        output_type=TaskOutput,  # æŒ‡å®šè¾“å‡ºç±»å‹
        retries=3,               # è‡ªåŠ¨é‡è¯• 3 æ¬¡
    )
    
    # å°±è¿™ä¹ˆç®€å•ï¼
    result = await agent.run("åˆ›å»ºä¸€ä¸ªç´§æ€¥ä»»åŠ¡")
    
    # result.output ä¿è¯æ˜¯åˆæ³•çš„ TaskOutput
    """)


# ============================================================
# æ¨¡æ‹Ÿ: è‡ªåŠ¨çº æ­£è¿‡ç¨‹
# ============================================================

def simulate_auto_correction():
    """æ¨¡æ‹Ÿè‡ªåŠ¨çº æ­£è¿‡ç¨‹"""
    
    print("\n" + "=" * 60)
    print("æ¨¡æ‹Ÿ: è‡ªåŠ¨çº æ­£è¿‡ç¨‹")
    print("=" * 60)
    
    print("""
    ç”¨æˆ·è¾“å…¥: "åˆ›å»ºä¸€ä¸ªç´§æ€¥ä»»åŠ¡ï¼Œé¢„è®¡ 2 å°æ—¶"
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬ 1 æ¬¡å°è¯• (LLM è¿”å›)                                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ {                                                        â”‚
    â”‚   "task_name": "ç´§æ€¥ä»»åŠ¡",                               â”‚
    â”‚   "priority": "HIGH",        â† é”™è¯¯: åº”è¯¥å°å†™            â”‚
    â”‚   "estimated_hours": "2",    â† é”™è¯¯: åº”è¯¥æ˜¯æ•°å­—          â”‚
    â”‚   "assignee_email": "none",  â† é”™è¯¯: æ— æ•ˆé‚®ç®±            â”‚
    â”‚   "tags": []                 â† é”™è¯¯: è‡³å°‘ 1 ä¸ª           â”‚
    â”‚ }                                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ ValidationError
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Pydantic AI è‡ªåŠ¨æ„é€ é‡è¯•æç¤º:                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ä¹‹å‰è¿”å›çš„æ•°æ®æœ‰è¯¯:                                      â”‚
    â”‚ - priority: è¾“å…¥åº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æšä¸¾æˆå‘˜                 â”‚
    â”‚ - estimated_hours: è¾“å…¥åº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—              â”‚
    â”‚ - assignee_email: æ— æ•ˆçš„é‚®ç®±åœ°å€: none                   â”‚
    â”‚ - tags: åˆ—è¡¨é¡¹æ•°åº”å¤§äºæˆ–ç­‰äº 1                           â”‚
    â”‚                                                          â”‚
    â”‚ è¯·ä¿®æ­£è¿™äº›é”™è¯¯å¹¶é‡æ–°è¿”å›ã€‚                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ è‡ªåŠ¨é‡è¯•
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬ 2 æ¬¡å°è¯• (LLM è¿”å›)                                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ {                                                        â”‚
    â”‚   "task_name": "ç´§æ€¥ä»»åŠ¡",                               â”‚
    â”‚   "priority": "high",        â† ä¿®æ­£                      â”‚
    â”‚   "estimated_hours": 2,      â† ä¿®æ­£                      â”‚
    â”‚   "assignee_email": "user@example.com",                  â”‚
    â”‚   "tags": ["urgent"]         â† ä¿®æ­£                      â”‚
    â”‚ }                                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ æ ¡éªŒé€šè¿‡ âœ…
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿”å› TaskOutput å¯¹è±¡                                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ TaskOutput(                                              â”‚
    â”‚   task_name='ç´§æ€¥ä»»åŠ¡',                                  â”‚
    â”‚   priority=<Priority.HIGH: 'high'>,                     â”‚
    â”‚   estimated_hours=2.0,                                   â”‚
    â”‚   assignee_email='user@example.com',                     â”‚
    â”‚   tags=['urgent']                                        â”‚
    â”‚ )                                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    ğŸ’¡ å…¨ç¨‹é›¶æ‰‹å†™é‡è¯•ä»£ç !
    """)


# ============================================================
# æ¼”ç¤º: ä¸åŒç±»å‹çš„æ ¡éªŒé”™è¯¯
# ============================================================

def demo_validation_errors():
    """æ¼”ç¤ºä¸åŒç±»å‹çš„æ ¡éªŒé”™è¯¯"""
    
    print("\n" + "=" * 60)
    print("å¸¸è§æ ¡éªŒé”™è¯¯ç¤ºä¾‹")
    print("=" * 60)
    
    test_cases = [
        # (æ•°æ®, é”™è¯¯æè¿°)
        (
            {"task_name": "AB", "priority": "high", "estimated_hours": 2, "assignee_email": "a@b.c", "tags": ["a"]},
            "task_name å¤ªçŸ­ (æœ€å°‘ 3 å­—ç¬¦)"
        ),
        (
            {"task_name": "Task", "priority": "urgent", "estimated_hours": 2, "assignee_email": "a@b.c", "tags": ["a"]},
            "priority ä¸æ˜¯æœ‰æ•ˆæšä¸¾å€¼"
        ),
        (
            {"task_name": "Task", "priority": "high", "estimated_hours": 200, "assignee_email": "a@b.c", "tags": ["a"]},
            "estimated_hours è¶…å‡ºèŒƒå›´ (æœ€å¤§ 100)"
        ),
        (
            {"task_name": "Task", "priority": "high", "estimated_hours": 2, "assignee_email": "invalid", "tags": ["a"]},
            "assignee_email æ ¼å¼æ— æ•ˆ"
        ),
        (
            {"task_name": "Task", "priority": "high", "estimated_hours": 2, "assignee_email": "a@b.c", "tags": []},
            "tags ä¸ºç©º (æœ€å°‘ 1 ä¸ª)"
        ),
    ]
    
    for data, description in test_cases:
        print(f"\nâŒ {description}")
        print(f"   æ•°æ®: {data}")
        try:
            TaskOutput(**data)
        except ValidationError as e:
            for error in e.errors():
                print(f"   â†’ {error['loc'][0]}: {error['msg']}")


# ============================================================
# æ€»ç»“
# ============================================================

def print_summary():
    """è‡ªåŠ¨çº æ­£æ€»ç»“"""
    
    print("\n" + "=" * 60)
    print("è‡ªåŠ¨é”™è¯¯çº æ­£æ€»ç»“")
    print("=" * 60)
    
    print("""
    Pydantic AI è‡ªåŠ¨çº æ­£æœºåˆ¶:
    
    1. å·¥ä½œåŸç†:
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ LLM è¿”å›    â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Pydantic    â”‚
       â”‚ æ ¡éªŒ        â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚ é”™è¯¯?   â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          Yes â”‚ No
              â”‚  â””â”€â”€â†’ è¿”å›ç»“æœ âœ…
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ æ„é€ é‡è¯•    â”‚
       â”‚ æç¤º        â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ è‡ªåŠ¨é‡è¯•    â”‚
       â”‚ (æœ€å¤š N æ¬¡) â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€â”€â†’ å›åˆ° LLM
    
    2. é…ç½®:
       agent = Agent(
           output_type=TaskOutput,
           retries=3,  # æœ€å¤šé‡è¯• 3 æ¬¡
       )
    
    3. ä»·å€¼:
       - é›¶æ‰‹å†™é‡è¯•ä»£ç 
       - è‡ªåŠ¨å¤„ç† ValidationError
       - è‡ªåŠ¨æ„é€ é‡è¯•æç¤º
       - å¼ºåˆ¶ LLM è¿”å›åˆæ³•æ•°æ®
    
    ğŸ¯ ç»“æœ: ä¸å¯é çš„æ–‡æœ¬ â†’ å¯é çš„æ•°æ®
    """)


# ============================================================
# è¿è¡Œæ¼”ç¤º
# ============================================================

async def main():
    demo_manual_retry()
    await demo_auto_correction()
    simulate_auto_correction()
    demo_validation_errors()
    print_summary()


if __name__ == "__main__":
    asyncio.run(main())
